<% layout('layout') %>

<%- include("modules/header.ejs") %>

<main class="container-xxl py-4">
  <h1 class="h3 mb-4">Настройки</h1>

  <div class="row g-4">
    <div class="col-12 col-lg-6">
      <div class="card rounded-4">
        <div class="card-body">
          <h2 class="h5 mb-3">Смена пароля администратора</h2>
          <form id="changePassForm" class="d-grid gap-3">
            <div>
              <label class="form-label">Новый пароль</label>
              <input type="password" id="newPassword" class="form-control rounded-4" placeholder="Введите новый пароль" required>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-primary rounded-4" type="submit">Сохранить</button>
              <button class="btn btn-outline-secondary rounded-4" type="button" id="toggleNew">Показать</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card rounded-4">
        <div class="card-body">
          <h2 class="h5 mb-3">Сброс пароля</h2>
          <p class="text-muted">Удалит текущий пароль и вернёт приложение к режиму регистрации.</p>
          <button id="resetPassBtn" class="btn btn-danger rounded-4">Сбросить пароль</button>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card rounded-4">
        <div class="card-body">
          <h2 class="h5 mb-3">Путь для сохранения файлов</h2>
          <form id="pathSettingsForm" class="d-grid gap-3">
            <div class="d-flex flex-wrap gap-3 align-items-center">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="useAppPathSwitch">
                <label class="form-check-label" for="useAppPathSwitch">Использовать папку приложения</label>
              </div>
            </div>
            <div id="customPathSection" style="display: none;">
              <label class="form-label">Кастомный путь</label>
              <div class="input-group">
                <input type="text" id="customPathInput" class="form-control rounded-4" placeholder="C:\Users\Username\Documents\Qloud">
                <button class="btn btn-outline-secondary rounded-4" type="button" id="browsePathBtn">Обзор</button>
              </div>
              <div class="form-text">Укажите полный путь к папке, где будут сохраняться файлы</div>
            </div>
            <div class="alert alert-info">
              <strong>Текущий путь:</strong> <span id="currentPathDisplay">Загрузка...</span>
            </div>
            <div class="alert alert-warning">
              <strong>При изменении пути будут мигрированы:</strong>
              <ul class="mb-0 mt-2">
                <li>Загруженные файлы (uploads/)</li>
                <li>Торрент файлы (torrents/)</li>
                <li>История чата (chat.json)</li>
                <li>Настройки (config.json)</li>
                <li>Пароль администратора (password.txt)</li>
              </ul>
            </div>
            <div>
              <button class="btn btn-success rounded-4" type="submit">Сохранить</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card rounded-4">
        <div class="card-body">
          <h2 class="h5 mb-3">Кэш статических файлов</h2>
          <div class="d-flex flex-wrap gap-3 align-items-center">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" role="switch" id="cacheSwitch">
              <label class="form-check-label" for="cacheSwitch">Включить кэш</label>
            </div>
            <button class="btn btn-outline-warning rounded-4" id="invalidateCacheBtn">Очистить кэш</button>
            <span class="small text-muted" id="cacheVer"></span>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card rounded-4">
        <div class="card-body">
          <h2 class="h5 mb-3">История чата</h2>
          <form id="chatSettingsForm" class="d-grid gap-3">
            <div>
              <label class="form-label">Лимит сообщений</label>
              <input type="number" min="10" max="10000" step="10" id="chatLimit" class="form-control rounded-4" placeholder="Например, 100">
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-primary rounded-4" type="submit">Сохранить</button>
              <button class="btn btn-outline-danger rounded-4" type="button" id="clearChatBtn">Очистить историю</button>
            </div>
          </form>
        </div>
      </div>
    </div>


    <div class="col-12 col-lg-6">
      <div class="card rounded-4">
        <div class="card-body">
          <h2 class="h5 mb-3">Kinopoisk API</h2>
          <form id="kinopoiskSettingsForm" class="d-grid gap-3">
            <div>
              <label class="form-label">Kinopoisk API ключ</label>
              <input type="text" id="kinopoiskApiKey" class="form-control rounded-4" placeholder="N6SXSYN-P1PM36E-Q6Y1NK4-GBFNPK7">
              <div class="form-text">Ключ для поиска фильмов через официальный Kinopoisk API</div>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-primary rounded-4" type="submit">Сохранить</button>
              <button class="btn btn-outline-info rounded-4" type="button" id="testKinopoiskBtn">Проверить ключ</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>





  <div class="row g-4 mt-1">
    <div class="col-12 col-lg-6">
      <div class="card rounded-4">
        <div class="card-body">
          <h2 class="h5 mb-3">Параметры интерфейса</h2>
          <form id="uiSettingsForm" class="d-grid gap-3">
            <div class="d-flex flex-wrap gap-3 align-items-center">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="themeSwitch">
                <label class="form-check-label" for="themeSwitch">Тёмная тема</label>
              </div>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="autorunSwitch">
                <label class="form-check-label" for="autorunSwitch">Автозапуск (Windows)</label>
              </div>
            </div>
            <div>
              <button class="btn btn-success rounded-4" type="submit">Сохранить</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-6">
      <div class="card rounded-4">
        <div class="card-body">
          <h2 class="h5 mb-3">О приложении</h2>
          <div class="text-muted small">
            Qloud — медиа‑сервер и файловый менеджер. Автор: Flash.
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
  const asciiRe = /^[\x21-\x7E]+$/;

  const toggle = (input, btn) => {
    if (input.type === 'password') { input.type = 'text'; btn.textContent = 'Скрыть'; }
    else { input.type = 'password'; btn.textContent = 'Показать'; }
  }

  document.getElementById('toggleNew').addEventListener('click', () => toggle(document.getElementById('newPassword'), document.getElementById('toggleNew')));

  document.getElementById('changePassForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const newPassword = document.getElementById('newPassword').value.trim();
    if (!newPassword) return alert('Введите пароль');
    if (!asciiRe.test(newPassword)) return alert('Разрешены только латинские буквы, цифры и спецсимволы без пробелов');

    const res = await fetch('/auth-api/change-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ newPassword })
    });
    const data = await res.json();
    if (data.success) {
      alert('Пароль обновлён');
      document.getElementById('newPassword').value = '';
    } else {
      alert(data.msg || 'Ошибка обновления пароля');
    }
  });

  document.getElementById('resetPassBtn').addEventListener('click', async () => {
    if (!confirm('Вы уверены, что хотите сбросить пароль?')) return;
    const res = await fetch('/auth-api/reset-password', { method: 'POST' });
    const data = await res.json();
    if (data.success) {
      alert('Пароль сброшен. Сейчас вы будете перенаправлены на страницу регистрации.');
      window.location.href = '/auth';
    } else {
      alert(data.msg || 'Ошибка сброса пароля');
    }
  });

  // Bootstrap settings from API and wire up switches
  (async () => {
    try {
      const res = await fetch('/api/settings');
      const { config, currentPath } = await res.json();
      if (config) {
        // Path settings
        const useAppPathSwitch = document.getElementById('useAppPathSwitch');
        const customPathSection = document.getElementById('customPathSection');
        const customPathInput = document.getElementById('customPathInput');
        const currentPathDisplay = document.getElementById('currentPathDisplay');
        
        useAppPathSwitch.checked = config.useAppPath !== false;
        customPathInput.value = config.customPath || '';
        currentPathDisplay.textContent = currentPath || 'Неизвестно';
        
        // Показываем/скрываем секцию кастомного пути
        const toggleCustomPath = () => {
          customPathSection.style.display = useAppPathSwitch.checked ? 'none' : 'block';
        };
        toggleCustomPath();
        
        useAppPathSwitch.addEventListener('change', toggleCustomPath);
        
        // Обработка формы пути
        document.getElementById('pathSettingsForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          const useAppPath = useAppPathSwitch.checked;
          const customPath = customPathInput.value.trim();
          
          if (!useAppPath && !customPath) {
            alert('Укажите кастомный путь или включите использование папки приложения');
            return;
          }
          
          // Показываем индикатор загрузки
          const submitBtn = e.target.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;
          submitBtn.textContent = 'Миграция данных...';
          submitBtn.disabled = true;
          
          try {
            const res = await fetch('/api/settings', {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ useAppPath, customPath: useAppPath ? null : customPath })
            });
            
            const data = await res.json();
            if (data.success) {
              currentPathDisplay.textContent = data.currentPath;
              alert('Путь сохранения обновлён и данные мигрированы успешно!');
              // Перезагружаем страницу для применения изменений
              setTimeout(() => window.location.reload(), 1000);
            } else {
              alert('Ошибка обновления пути: ' + (data.msg || 'Неизвестная ошибка'));
            }
          } catch (error) {
            alert('Ошибка сети: ' + error.message);
          } finally {
            // Восстанавливаем кнопку
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
          }
        });

        // Theme
        const isDark = config.theme === 'dark';
        const themeSwitch = document.getElementById('themeSwitch');
        themeSwitch.checked = isDark;
        const applyTheme = (t) => {
          document.documentElement.setAttribute('data-theme', t);
          document.documentElement.setAttribute('data-bs-theme', t);
          try { localStorage.setItem('qloud_theme', t); } catch(e) {}
        };
        applyTheme(isDark ? 'dark' : 'light');
        themeSwitch.onchange = (e) => {
          const theme = e.target.checked ? 'dark' : 'light';
          applyTheme(theme);
        };

        // Autorun (Windows)
        const autorunSwitch = document.getElementById('autorunSwitch');
        autorunSwitch.checked = !!config.autorun;
        autorunSwitch.onchange = async (e) => {
          const autorun = !!e.target.checked;
          await fetch('/api/settings', { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ autorun }) });
          await fetch('/api/settings/autorun/apply', { method: 'POST' });
        };

        // Cache
        const cacheSwitch = document.getElementById('cacheSwitch');
        cacheSwitch.checked = !!config.cacheEnabled;
        document.getElementById('cacheVer').textContent = `Версия кэша: ${config.cacheVersion || 1}`;
        cacheSwitch.onchange = async (e) => {
          const cacheEnabled = !!e.target.checked;
          await fetch('/api/settings', { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ cacheEnabled }) });
        };
        document.getElementById('invalidateCacheBtn').addEventListener('click', async () => {
          const r = await fetch('/api/settings/cache/invalidate', { method: 'POST' });
          const d = await r.json();
          if (d && d.success) {
            document.getElementById('cacheVer').textContent = `Версия кэша: ${d.config.cacheVersion}`;
            alert('Кэш обновлён. Обновите страницу (Ctrl+F5)');
          }
        });

        // Chat settings
        const chatLimit = document.getElementById('chatLimit');
        chatLimit.value = config.chatHistoryLimit || 100;
        document.getElementById('chatSettingsForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          const val = parseInt(chatLimit.value, 10);
          if (!Number.isInteger(val) || val <= 0) return alert('Введите корректное число');
          await fetch('/api/settings', { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ chatHistoryLimit: val }) });
          // попросим чат применить лимит
          try {
            const s = window.io && window.io();
            if (s) s.emit('chat:applyLimit');
          } catch(_) {}
          alert('Настройки чата сохранены');
        });

        document.getElementById('clearChatBtn').addEventListener('click', async () => {
          if (!confirm('Очистить всю историю чата?')) return;
          const r = await fetch('/api/settings/chat/clear', { method: 'POST' });
          const d = await r.json();
          if (d && d.success) alert('История чата очищена');
        });



        // Kinopoisk API настройки
        const kinopoiskApiKeyInput = document.getElementById('kinopoiskApiKey');
        const kinopoiskSettingsForm = document.getElementById('kinopoiskSettingsForm');
        const testKinopoiskBtn = document.getElementById('testKinopoiskBtn');

        if (kinopoiskApiKeyInput) {
            kinopoiskApiKeyInput.value = config.kinopoiskApiKey || 'N6SXSYN-P1PM36E-Q6Y1NK4-GBFNPK7';
        }

        if (kinopoiskSettingsForm) {
            kinopoiskSettingsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const apiKey = kinopoiskApiKeyInput.value.trim();
                
                if (!apiKey) {
                    alert('Введите Kinopoisk API ключ');
                    return;
                }

                try {
                    const res = await fetch('/api/settings', {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ kinopoiskApiKey: apiKey })
                    });
                    
                    const data = await res.json();
                    
                    if (data.success) {
                        alert('Настройки Kinopoisk API обновлены');
                    } else {
                        alert(data.msg || 'Ошибка обновления настроек');
                    }
                } catch (error) {
                    console.error('Fetch error:', error);
                    alert('Ошибка сети: ' + error.message);
                }
            });
        }

        testKinopoiskBtn.addEventListener('click', async () => {
          const apiKey = kinopoiskApiKeyInput.value.trim();
          
          if (!apiKey) {
            alert('Введите Kinopoisk API ключ для проверки');
            return;
          }
          
          try {
            console.log('Testing Kinopoisk API connection...');
            const res = await fetch('/api/kinopoisk/test', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ apiKey })
            });
            
            const data = await res.json();
            if (data.success) {
              alert('Kinopoisk API успешно подключен!');
            } else {
              alert(data.msg || 'Ошибка подключения к Kinopoisk API');
            }
          } catch (error) {
            console.error('Kinopoisk test error:', error);
            alert('Ошибка при проверке подключения: ' + error.message);
          }
        });
      }
    } catch (e) {}
  })();

  // Сохранение UI-настроек
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('uiSettingsForm');
    if (!form) return;
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const theme = document.getElementById('themeSwitch').checked ? 'dark' : 'light';
      const autorun = document.getElementById('autorunSwitch').checked;
      await fetch('/api/settings', { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ theme, autorun }) });
      await fetch('/api/settings/autorun/apply', { method: 'POST' });
      alert('Настройки интерфейса сохранены');
    });
  });

  // Локализация фильмов
  document.addEventListener('DOMContentLoaded', () => {
    const loadStatsBtn = document.getElementById('loadLocalizationStatsBtn');
    const clearCacheBtn = document.getElementById('clearTmdbCacheBtn');
    const translationForm = document.getElementById('translationForm');
    const statsSpan = document.getElementById('localizationStats');

    // Загрузка статистики локализации
    async function loadLocalizationStats() {
      try {
        const res = await fetch('/api/tmdb/localization/stats');
        const data = await res.json();
        
        if (data.success) {
          const stats = data.data;
          statsSpan.textContent = `Переводов: ${stats.totalTranslations}, Кэш: ${stats.cacheSize} записей`;
        } else {
          statsSpan.textContent = 'Ошибка загрузки статистики';
        }
      } catch (error) {
        console.error('Error loading localization stats:', error);
        statsSpan.textContent = 'Ошибка загрузки';
      }
    }

    // Очистка кэша TMDB
    if (clearCacheBtn) {
      clearCacheBtn.addEventListener('click', async () => {
        if (!confirm('Очистить кэш TMDB? Это может замедлить работу при следующем поиске фильмов.')) {
          return;
        }
        
        try {
          const res = await fetch('/api/tmdb/cache/clear', { method: 'POST' });
          const data = await res.json();
          
          if (data.success) {
            alert('Кэш TMDB очищен');
            loadLocalizationStats(); // Обновляем статистику
          } else {
            alert(data.msg || 'Ошибка очистки кэша');
          }
        } catch (error) {
          console.error('Error clearing cache:', error);
          alert('Ошибка очистки кэша: ' + error.message);
        }
      });
    }

    // Загрузка статистики при клике
    if (loadStatsBtn) {
      loadStatsBtn.addEventListener('click', loadLocalizationStats);
    }

    // Форма добавления переводов
    if (translationForm) {
      translationForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const englishName = document.getElementById('englishName').value.trim();
        const russianName = document.getElementById('russianName').value.trim();
        
        if (!englishName || !russianName) {
          alert('Заполните оба поля');
          return;
        }
        
        try {
          const res = await fetch('/api/tmdb/localization/translations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ englishName, russianName })
          });
          
          const data = await res.json();
          
          if (data.success) {
            alert('Перевод добавлен');
            document.getElementById('englishName').value = '';
            document.getElementById('russianName').value = '';
            loadLocalizationStats(); // Обновляем статистику
          } else {
            alert(data.msg || 'Ошибка добавления перевода');
          }
        } catch (error) {
          console.error('Error adding translation:', error);
          alert('Ошибка добавления перевода: ' + error.message);
        }
      });
    }

    // Загружаем статистику при загрузке страницы
    loadLocalizationStats();
  });


</script>

