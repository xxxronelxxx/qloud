<% layout('layout') %>

<%- include("modules/header.ejs") %>

<main class="container-xxl py-4">
  <h1 class="h3 mb-4">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>

  <div class="row g-4">
    <div class="col-12 col-lg-6">
      <div class="card rounded-4">
        <div class="card-body">
          <h2 class="h5 mb-3">–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
          <form id="changePassForm" class="d-grid gap-3">
            <div>
              <label class="form-label">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
              <input type="password" id="newPassword" class="form-control rounded-4" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" required>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-primary rounded-4" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button class="btn btn-outline-secondary rounded-4" type="button" id="toggleNew">–ü–æ–∫–∞–∑–∞—Ç—å</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card rounded-4">
        <div class="card-body">
          <h2 class="h5 mb-3">–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è</h2>
          <p class="text-muted">–£–¥–∞–ª–∏—Ç —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å –∏ –≤–µ—Ä–Ω—ë—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫ —Ä–µ–∂–∏–º—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.</p>
          <button id="resetPassBtn" class="btn btn-danger rounded-4">–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card rounded-4">
        <div class="card-body">
          <h2 class="h5 mb-3">–ü—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤</h2>
          <form id="pathSettingsForm" class="d-grid gap-3">
            <div class="d-flex flex-wrap gap-3 align-items-center">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="useAppPathSwitch">
                <label class="form-check-label" for="useAppPathSwitch">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞–ø–∫—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</label>
              </div>
            </div>
            <div id="customPathSection" style="display: none;">
              <label class="form-label">–ö–∞—Å—Ç–æ–º–Ω—ã–π –ø—É—Ç—å</label>
              <div class="input-group">
                <input type="text" id="customPathInput" class="form-control rounded-4" placeholder="C:\Users\Username\Documents\Qloud">
                <button class="btn btn-outline-secondary rounded-4" type="button" id="browsePathBtn">–û–±–∑–æ—Ä</button>
              </div>
              <div class="form-text">–£–∫–∞–∂–∏—Ç–µ –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ, –≥–¥–µ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è —Ñ–∞–π–ª—ã</div>
            </div>
            <div class="alert alert-info">
              <strong>–¢–µ–∫—É—â–∏–π –ø—É—Ç—å:</strong> <span id="currentPathDisplay">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <div class="alert alert-warning">
              <strong>–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—É—Ç–∏ –±—É–¥—É—Ç –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã:</strong>
              <ul class="mb-0 mt-2">
                <li>–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (uploads/)</li>
                <li>–¢–æ—Ä—Ä–µ–Ω—Ç —Ñ–∞–π–ª—ã (torrents/)</li>
                <li>–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ (chat.json)</li>
                <li>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ (config.json)</li>
                <li>–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (password.txt)</li>
              </ul>
            </div>
            <div>
              <button class="btn btn-success rounded-4" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card rounded-4">
        <div class="card-body">
          <h2 class="h5 mb-3">–ö—ç—à —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤</h2>
          <div class="d-flex flex-wrap gap-3 align-items-center">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" role="switch" id="cacheSwitch">
              <label class="form-check-label" for="cacheSwitch">–í–∫–ª—é—á–∏—Ç—å –∫—ç—à</label>
            </div>
            <button class="btn btn-outline-warning rounded-4" id="invalidateCacheBtn">–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à</button>
            <span class="small text-muted" id="cacheVer"></span>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card rounded-4">
        <div class="card-body">
          <h2 class="h5 mb-3">–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞</h2>
          <form id="chatSettingsForm" class="d-grid gap-3">
            <div>
              <label class="form-label">–õ–∏–º–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</label>
              <input type="number" min="10" max="10000" step="10" id="chatLimit" class="form-control rounded-4" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 100">
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-primary rounded-4" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button class="btn btn-outline-danger rounded-4" type="button" id="clearChatBtn">–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card rounded-4">
        <div class="card-body">
          <h2 class="h5 mb-3">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Kinozal.tv</h2>
          <form id="kinozalSettingsForm" class="d-grid gap-3">
            <div>
              <label class="form-label">–õ–æ–≥–∏–Ω</label>
              <input type="text" id="kinozalLogin" class="form-control rounded-4" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω">
            </div>
            <div>
              <label class="form-label">–ü–∞—Ä–æ–ª—å</label>
              <div class="input-group">
                <input type="password" id="kinozalPassword" class="form-control rounded-4" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                <button class="btn btn-outline-secondary rounded-4" type="button" id="toggleKinozalPassword">–ü–æ–∫–∞–∑–∞—Ç—å</button>
              </div>
            </div>
            <div>
              <label class="form-label">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ cookie</label>
              <textarea id="kinozalCookies" class="form-control rounded-4" rows="2" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: cf_clearance=...; sid=..."></textarea>
              <div class="form-text">–ú–æ–∂–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å cookie –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞, –µ—Å–ª–∏ —Å–∞–π—Ç –∑–∞—â–∏—â–µ–Ω Cloudflare.</div>
            </div>
            <div>
              <label class="form-label">–ü—Ä–æ–∫—Å–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
              <input type="text" id="kinozalProxy" class="form-control rounded-4" placeholder="http://user:pass@host:port –∏–ª–∏ socks5://host:port">
              <div class="form-text">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–æ–∫—Å–∏ –ø—Ä–∏ —Å–µ—Ç–µ–≤—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è—Ö.</div>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-primary rounded-4" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button class="btn btn-outline-info rounded-4" type="button" id="testKinozalBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
              <button class="btn btn-outline-secondary rounded-4" type="button" id="checkKinozalAccessBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-6">
      <div class="card rounded-4">
        <div class="card-body">
          <h2 class="h5 mb-3">TMDB API</h2>
          <form id="tmdbSettingsForm" class="d-grid gap-3">
            <div>
              <label class="form-label">TMDB API –∫–ª—é—á</label>
              <input type="text" id="tmdbApiKey" class="form-control rounded-4" placeholder="–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á TMDB">
              <div class="form-text">–ü–æ–ª—É—á–∏—Ç–µ –∫–ª—é—á –Ω–∞ themoviedb.org –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∞–∫–∫–∞—É–Ω—Ç–∞</div>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-primary rounded-4" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button class="btn btn-outline-info rounded-4" type="button" id="testTmdbBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–ª—é—á</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4 mt-1">
    <div class="col-12">
      <div class="card rounded-4">
        <div class="card-body">
          <h2 class="h5 mb-3">–õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å–º–æ–≤</h2>
          <div class="row g-3">
            <div class="col-12 col-md-6">
              <div class="d-flex flex-wrap gap-3 align-items-center mb-3">
                <button class="btn btn-outline-info rounded-4" type="button" id="loadLocalizationStatsBtn">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
                <button class="btn btn-outline-warning rounded-4" type="button" id="clearTmdbCacheBtn">–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à TMDB</button>
                <span class="small text-muted" id="localizationStats">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
              </div>
              <div class="alert alert-info">
                <strong>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong> –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –∏–º–µ–Ω–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∞–∫—Ç–µ—Ä–æ–≤ –∏ —Ä–µ–∂–∏—Å—Å–µ—Ä–æ–≤ –Ω–∞ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫. 
                –í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–≤–æ–¥—ã –Ω–∏–∂–µ.
              </div>
              <div class="alert alert-success">
                <strong>–ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è:</strong> –°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–æ–∏—Å–∫ —Ä—É—Å—Å–∫–∏—Ö —Ñ–∏–ª—å–º–æ–≤ –∏ —Ñ–∏–ª—å–º–æ–≤ —Å —Ä—É—Å—Å–∫–∏–º–∏ –ø–µ—Ä–µ–≤–æ–¥–∞–º–∏!
              </div>
              <div class="alert alert-info">
                <strong>–õ–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:</strong> –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –±–∞–∑–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç 8 –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ä—É—Å—Å–∫–∏—Ö —Ñ–∏–ª—å–º–æ–≤ –∏ 5 —Å–µ—Ä–∏–∞–ª–æ–≤, –≤–∫–ª—é—á–∞—è "–õ–∏–∫–≤–∏–¥–∞—Ü–∏—é", "–ë—Ä–∞—Ç", "–õ–µ–≤–∏–∞—Ñ–∞–Ω" –∏ –¥—Ä—É–≥–∏–µ.
              </div>
            </div>
            <div class="col-12 col-md-6">
              <form id="translationForm" class="d-grid gap-3">
                <div>
                  <label class="form-label">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥ –∏–º–µ–Ω–∏</label>
                  <div class="row g-2">
                    <div class="col-6">
                      <input type="text" id="englishName" class="form-control rounded-4" placeholder="–ê–Ω–≥–ª–∏–π—Å–∫–æ–µ –∏–º—è">
                    </div>
                    <div class="col-6">
                      <input type="text" id="russianName" class="form-control rounded-4" placeholder="–†—É—Å—Å–∫–æ–µ –∏–º—è">
                    </div>
                  </div>
                </div>
                <div>
                  <button class="btn btn-success rounded-4" type="submit">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4 mt-1">
    <div class="col-12">
      <div class="card rounded-4">
        <div class="card-body">
          <h2 class="h5 mb-3">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∏—Å–∫–∞ —Ä—É—Å—Å–∫–∏—Ö —Ñ–∏–ª—å–º–æ–≤</h2>
          <div class="row g-3">
            <div class="col-12 col-md-8">
              <form id="russianMovieSearchForm" class="d-grid gap-3">
                <div class="row g-2">
                  <div class="col-8">
                    <input type="text" id="russianMovieQuery" class="form-control rounded-4" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ë—Ä–∞—Ç, –õ–µ–≤–∏–∞—Ñ–∞–Ω, –°—Ç–∞–ª–∫–µ—Ä)">
                  </div>
                  <div class="col-4">
                    <input type="number" id="russianMovieYear" class="form-control rounded-4" placeholder="–ì–æ–¥ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" min="1900" max="2030">
                  </div>
                </div>
                <div>
                  <button class="btn btn-primary rounded-4" type="submit">–ù–∞–π—Ç–∏ —Ä—É—Å—Å–∫–∏–π —Ñ–∏–ª—å–º</button>
                </div>
              </form>
            </div>
            <div class="col-12 col-md-4">
              <div class="d-flex flex-wrap gap-3 align-items-center">
                <button class="btn btn-outline-info rounded-4" type="button" id="loadRussianStatsBtn">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
                <button class="btn btn-outline-warning rounded-4" type="button" id="clearRussianCacheBtn">–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à</button>
                <span class="small text-muted" id="russianStats">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
              </div>
            </div>
          </div>
          <div id="russianMovieResult" class="mt-3" style="display: none;">
            <div class="alert alert-info">
              <h6>–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–∏—Å–∫–∞:</h6>
              <div id="russianMovieResultContent"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4 mt-1">
    <div class="col-12 col-lg-6">
      <div class="card rounded-4">
        <div class="card-body">
          <h2 class="h5 mb-3">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</h2>
          <form id="uiSettingsForm" class="d-grid gap-3">
            <div class="d-flex flex-wrap gap-3 align-items-center">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="themeSwitch">
                <label class="form-check-label" for="themeSwitch">–¢—ë–º–Ω–∞—è —Ç–µ–º–∞</label>
              </div>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="autorunSwitch">
                <label class="form-check-label" for="autorunSwitch">–ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ (Windows)</label>
              </div>
            </div>
            <div>
              <button class="btn btn-success rounded-4" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-6">
      <div class="card rounded-4">
        <div class="card-body">
          <h2 class="h5 mb-3">–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</h2>
          <div class="text-muted small">
            Qloud ‚Äî –º–µ–¥–∏–∞‚Äë—Å–µ—Ä–≤–µ—Ä –∏ —Ñ–∞–π–ª–æ–≤—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä. –ê–≤—Ç–æ—Ä: Flash.
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
  const asciiRe = /^[\x21-\x7E]+$/;

  const toggle = (input, btn) => {
    if (input.type === 'password') { input.type = 'text'; btn.textContent = '–°–∫—Ä—ã—Ç—å'; }
    else { input.type = 'password'; btn.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å'; }
  }

  document.getElementById('toggleNew').addEventListener('click', () => toggle(document.getElementById('newPassword'), document.getElementById('toggleNew')));

  document.getElementById('changePassForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const newPassword = document.getElementById('newPassword').value.trim();
    if (!newPassword) return alert('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å');
    if (!asciiRe.test(newPassword)) return alert('–†–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤');

    const res = await fetch('/auth-api/change-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ newPassword })
    });
    const data = await res.json();
    if (data.success) {
      alert('–ü–∞—Ä–æ–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω');
      document.getElementById('newPassword').value = '';
    } else {
      alert(data.msg || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è');
    }
  });

  document.getElementById('resetPassBtn').addEventListener('click', async () => {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å?')) return;
    const res = await fetch('/auth-api/reset-password', { method: 'POST' });
    const data = await res.json();
    if (data.success) {
      alert('–ü–∞—Ä–æ–ª—å —Å–±—Ä–æ—à–µ–Ω. –°–µ–π—á–∞—Å –≤—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.');
      window.location.href = '/auth';
    } else {
      alert(data.msg || '–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è');
    }
  });

  // Bootstrap settings from API and wire up switches
  (async () => {
    try {
      const res = await fetch('/api/settings');
      const { config, currentPath } = await res.json();
      if (config) {
        // Path settings
        const useAppPathSwitch = document.getElementById('useAppPathSwitch');
        const customPathSection = document.getElementById('customPathSection');
        const customPathInput = document.getElementById('customPathInput');
        const currentPathDisplay = document.getElementById('currentPathDisplay');
        
        useAppPathSwitch.checked = config.useAppPath !== false;
        customPathInput.value = config.customPath || '';
        currentPathDisplay.textContent = currentPath || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –ø—É—Ç–∏
        const toggleCustomPath = () => {
          customPathSection.style.display = useAppPathSwitch.checked ? 'none' : 'block';
        };
        toggleCustomPath();
        
        useAppPathSwitch.addEventListener('change', toggleCustomPath);
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –ø—É—Ç–∏
        document.getElementById('pathSettingsForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          const useAppPath = useAppPathSwitch.checked;
          const customPath = customPathInput.value.trim();
          
          if (!useAppPath && !customPath) {
            alert('–£–∫–∞–∂–∏—Ç–µ –∫–∞—Å—Ç–æ–º–Ω—ã–π –ø—É—Ç—å –∏–ª–∏ –≤–∫–ª—é—á–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
            return;
          }
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
          const submitBtn = e.target.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;
          submitBtn.textContent = '–ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö...';
          submitBtn.disabled = true;
          
          try {
            const res = await fetch('/api/settings', {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ useAppPath, customPath: useAppPath ? null : customPath })
            });
            
            const data = await res.json();
            if (data.success) {
              currentPathDisplay.textContent = data.currentPath;
              alert('–ü—É—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª—ë–Ω –∏ –¥–∞–Ω–Ω—ã–µ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ!');
              // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
              setTimeout(() => window.location.reload(), 1000);
            } else {
              alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—É—Ç–∏: ' + (data.msg || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
          } catch (error) {
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
          } finally {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
          }
        });

        // Theme
        const isDark = config.theme === 'dark';
        const themeSwitch = document.getElementById('themeSwitch');
        themeSwitch.checked = isDark;
        const applyTheme = (t) => {
          document.documentElement.setAttribute('data-theme', t);
          document.documentElement.setAttribute('data-bs-theme', t);
          try { localStorage.setItem('qloud_theme', t); } catch(e) {}
        };
        applyTheme(isDark ? 'dark' : 'light');
        themeSwitch.onchange = (e) => {
          const theme = e.target.checked ? 'dark' : 'light';
          applyTheme(theme);
        };

        // Autorun (Windows)
        const autorunSwitch = document.getElementById('autorunSwitch');
        autorunSwitch.checked = !!config.autorun;
        autorunSwitch.onchange = async (e) => {
          const autorun = !!e.target.checked;
          await fetch('/api/settings', { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ autorun }) });
          await fetch('/api/settings/autorun/apply', { method: 'POST' });
        };

        // Cache
        const cacheSwitch = document.getElementById('cacheSwitch');
        cacheSwitch.checked = !!config.cacheEnabled;
        document.getElementById('cacheVer').textContent = `–í–µ—Ä—Å–∏—è –∫—ç—à–∞: ${config.cacheVersion || 1}`;
        cacheSwitch.onchange = async (e) => {
          const cacheEnabled = !!e.target.checked;
          await fetch('/api/settings', { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ cacheEnabled }) });
        };
        document.getElementById('invalidateCacheBtn').addEventListener('click', async () => {
          const r = await fetch('/api/settings/cache/invalidate', { method: 'POST' });
          const d = await r.json();
          if (d && d.success) {
            document.getElementById('cacheVer').textContent = `–í–µ—Ä—Å–∏—è –∫—ç—à–∞: ${d.config.cacheVersion}`;
            alert('–ö—ç—à –æ–±–Ω–æ–≤–ª—ë–Ω. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É (Ctrl+F5)');
          }
        });

        // Chat settings
        const chatLimit = document.getElementById('chatLimit');
        chatLimit.value = config.chatHistoryLimit || 100;
        document.getElementById('chatSettingsForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          const val = parseInt(chatLimit.value, 10);
          if (!Number.isInteger(val) || val <= 0) return alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ');
          await fetch('/api/settings', { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ chatHistoryLimit: val }) });
          // –ø–æ–ø—Ä–æ—Å–∏–º —á–∞—Ç –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ª–∏–º–∏—Ç
          try {
            const s = window.io && window.io();
            if (s) s.emit('chat:applyLimit');
          } catch(_) {}
          alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
        });

        document.getElementById('clearChatBtn').addEventListener('click', async () => {
          if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞?')) return;
          const r = await fetch('/api/settings/chat/clear', { method: 'POST' });
          const d = await r.json();
          if (d && d.success) alert('–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ –æ—á–∏—â–µ–Ω–∞');
        });

        // Kinozal.tv –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        const kinozalLoginInput = document.getElementById('kinozalLogin');
        const kinozalPasswordInput = document.getElementById('kinozalPassword');
        const kinozalCookiesInput = document.getElementById('kinozalCookies');
        const kinozalProxyInput = document.getElementById('kinozalProxy');
        const toggleKinozalPasswordBtn = document.getElementById('toggleKinozalPassword');
        const testKinozalBtn = document.getElementById('testKinozalBtn');
        const kinozalSettingsForm = document.getElementById('kinozalSettingsForm');

        console.log('Loading Kinozal settings...');
        console.log('Config kinozalLogin:', config.kinozalLogin ? '–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' : '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
        console.log('kinozalLoginInput found:', !!kinozalLoginInput);
        console.log('kinozalSettingsForm found:', !!kinozalSettingsForm);
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –ø–∞—Ä–æ–ª—è
        if (toggleKinozalPasswordBtn) {
          toggleKinozalPasswordBtn.addEventListener('click', () => {
            toggle(kinozalPasswordInput, toggleKinozalPasswordBtn);
          });
        }
        
        if (kinozalLoginInput) {
            kinozalLoginInput.value = config.kinozalLogin || '';
            console.log('Login input value set to:', kinozalLoginInput.value ? '–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' : '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
        }
        
        if (kinozalPasswordInput) {
            kinozalPasswordInput.value = config.kinozalPassword || '';
        }
        if (kinozalCookiesInput) {
            kinozalCookiesInput.value = config.kinozalCookies || '';
        }
        if (kinozalProxyInput) {
            kinozalProxyInput.value = config.kinozalProxy || '';
        }

        if (kinozalSettingsForm) {
            console.log('Adding submit listener to kinozalSettingsForm');
            kinozalSettingsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log('Kinozal form submitted');
                
                const login = kinozalLoginInput.value.trim();
                const password = kinozalPasswordInput.value.trim();
                const cookies = (kinozalCookiesInput?.value || '').trim();
                const proxy = (kinozalProxyInput?.value || '').trim();
                
                if (!login) {
                    alert('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –¥–ª—è Kinozal.tv');
                    return;
                }
                
                if (!password) {
                    alert('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è Kinozal.tv');
                    return;
                }

                console.log('Sending API request...');
                const requestBody = { kinozalLogin: login, kinozalPassword: password, kinozalCookies: cookies, kinozalProxy: proxy };
                console.log('Request body:', requestBody);
                
                try {
                    const res = await fetch('/api/settings', {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });
                    console.log('Response status:', res.status);
                    
                    const data = await res.json();
                    console.log('Response data:', data);
                    
                    if (data.success) {
                        alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Kinozal.tv –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
                        console.log('Success! New config:', data.config);
                    } else {
                        alert(data.msg || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫');
                    }
                } catch (error) {
                    console.error('Fetch error:', error);
                    alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
                }
            });
        } else {
            console.error('kinozalSettingsForm not found');
        }

        testKinozalBtn.addEventListener('click', async () => {
          const login = kinozalLoginInput.value.trim();
          const password = kinozalPasswordInput.value.trim();
          
          if (!login || !password) {
            alert('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            return;
          }
          
          try {
            console.log('Testing Kinozal connection...');
            const res = await fetch('/api/kinozal/test', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ login, password })
            });
            
            const data = await res.json();
            if (data.success) {
              alert('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Kinozal.tv —É—Å–ø–µ—à–Ω–æ!');
            } else {
              alert(data.msg || '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Kinozal.tv');
            }
          } catch (error) {
            console.error('Kinozal test error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message);
          }
        });

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–∞–π—Ç–∞
        const checkKinozalAccessBtn = document.getElementById('checkKinozalAccessBtn');
        if (checkKinozalAccessBtn) {
          checkKinozalAccessBtn.addEventListener('click', async () => {
            try {
              console.log('Checking Kinozal site access...');
              const res = await fetch('/api/kinozal/check-access');
              
              const data = await res.json();
              if (data.success) {
                alert('–°–∞–π—Ç Kinozal.tv –¥–æ—Å—Ç—É–ø–µ–Ω!');
              } else {
                alert(data.msg || '–°–∞–π—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
              }
            } catch (error) {
              console.error('Kinozal access check error:', error);
              alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏: ' + error.message);
            }
          });
        }

        // TMDB API –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        const tmdbApiKeyInput = document.getElementById('tmdbApiKey');
        const tmdbSettingsForm = document.getElementById('tmdbSettingsForm');
        const testTmdbBtn = document.getElementById('testTmdbBtn');

        console.log('Loading TMDB settings...');
        console.log('Config tmdbApiKey:', config.tmdbApiKey ? '–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' : '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
        console.log('tmdbApiKeyInput found:', !!tmdbApiKeyInput);
        console.log('tmdbSettingsForm found:', !!tmdbSettingsForm);

        if (tmdbApiKeyInput) {
            tmdbApiKeyInput.value = config.tmdbApiKey || '';
            console.log('TMDB API Key input value set to:', tmdbApiKeyInput.value ? '–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' : '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
        }

        if (tmdbSettingsForm) {
            console.log('Adding submit listener to tmdbSettingsForm');
            tmdbSettingsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log('TMDB form submitted');
                
                const apiKey = tmdbApiKeyInput.value.trim();
                
                if (!apiKey) {
                    alert('–í–≤–µ–¥–∏—Ç–µ TMDB API –∫–ª—é—á');
                    return;
                }

                console.log('Sending API request...');
                const requestBody = { tmdbApiKey: apiKey };
                console.log('Request body:', requestBody);
                
                try {
                    const res = await fetch('/api/settings', {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });
                    console.log('Response status:', res.status);
                    
                    const data = await res.json();
                    console.log('Response data:', data);
                    
                    if (data.success) {
                        alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ TMDB API –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
                        console.log('Success! New config:', data.config);
                    } else {
                        alert(data.msg || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫');
                    }
                } catch (error) {
                    console.error('Fetch error:', error);
                    alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
                }
            });
        } else {
            console.error('tmdbSettingsForm not found');
        }

        testTmdbBtn.addEventListener('click', async () => {
          const apiKey = tmdbApiKeyInput.value.trim();
          
          if (!apiKey) {
            alert('–í–≤–µ–¥–∏—Ç–µ TMDB API –∫–ª—é—á –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏');
            return;
          }
          
          try {
            console.log('Testing TMDB API connection...');
            const res = await fetch('/api/tmdb/test', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ apiKey })
            });
            
            const data = await res.json();
            if (data.success) {
              alert('TMDB API —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω!');
            } else {
              alert(data.msg || '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ TMDB API');
            }
          } catch (error) {
            console.error('TMDB test error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message);
          }
        });
      }
    } catch (e) {}
  })();

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ UI-–Ω–∞—Å—Ç—Ä–æ–µ–∫
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('uiSettingsForm');
    if (!form) return;
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const theme = document.getElementById('themeSwitch').checked ? 'dark' : 'light';
      const autorun = document.getElementById('autorunSwitch').checked;
      await fetch('/api/settings', { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ theme, autorun }) });
      await fetch('/api/settings/autorun/apply', { method: 'POST' });
      alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
    });
  });

  // –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å–º–æ–≤
  document.addEventListener('DOMContentLoaded', () => {
    const loadStatsBtn = document.getElementById('loadLocalizationStatsBtn');
    const clearCacheBtn = document.getElementById('clearTmdbCacheBtn');
    const translationForm = document.getElementById('translationForm');
    const statsSpan = document.getElementById('localizationStats');

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏
    async function loadLocalizationStats() {
      try {
        const res = await fetch('/api/tmdb/localization/stats');
        const data = await res.json();
        
        if (data.success) {
          const stats = data.data;
          statsSpan.textContent = `–ü–µ—Ä–µ–≤–æ–¥–æ–≤: ${stats.totalTranslations}, –ö—ç—à: ${stats.cacheSize} –∑–∞–ø–∏—Å–µ–π`;
        } else {
          statsSpan.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏';
        }
      } catch (error) {
        console.error('Error loading localization stats:', error);
        statsSpan.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
      }
    }

    // –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ TMDB
    if (clearCacheBtn) {
      clearCacheBtn.addEventListener('click', async () => {
        if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à TMDB? –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–º–µ–¥–ª–∏—Ç—å —Ä–∞–±–æ—Ç—É –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –ø–æ–∏—Å–∫–µ —Ñ–∏–ª—å–º–æ–≤.')) {
          return;
        }
        
        try {
          const res = await fetch('/api/tmdb/cache/clear', { method: 'POST' });
          const data = await res.json();
          
          if (data.success) {
            alert('–ö—ç—à TMDB –æ—á–∏—â–µ–Ω');
            loadLocalizationStats(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
          } else {
            alert(data.msg || '–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞');
          }
        } catch (error) {
          console.error('Error clearing cache:', error);
          alert('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞: ' + error.message);
        }
      });
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ
    if (loadStatsBtn) {
      loadStatsBtn.addEventListener('click', loadLocalizationStats);
    }

    // –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤
    if (translationForm) {
      translationForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const englishName = document.getElementById('englishName').value.trim();
        const russianName = document.getElementById('russianName').value.trim();
        
        if (!englishName || !russianName) {
          alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±–∞ –ø–æ–ª—è');
          return;
        }
        
        try {
          const res = await fetch('/api/tmdb/localization/translations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ englishName, russianName })
          });
          
          const data = await res.json();
          
          if (data.success) {
            alert('–ü–µ—Ä–µ–≤–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω');
            document.getElementById('englishName').value = '';
            document.getElementById('russianName').value = '';
            loadLocalizationStats(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
          } else {
            alert(data.msg || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–≤–æ–¥–∞');
          }
        } catch (error) {
          console.error('Error adding translation:', error);
          alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–≤–æ–¥–∞: ' + error.message);
        }
      });
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadLocalizationStats();
  });

  // –ü–æ–∏—Å–∫ —Ä—É—Å—Å–∫–∏—Ö —Ñ–∏–ª—å–º–æ–≤
  document.addEventListener('DOMContentLoaded', () => {
    const russianSearchForm = document.getElementById('russianMovieSearchForm');
    const loadRussianStatsBtn = document.getElementById('loadRussianStatsBtn');
    const clearRussianCacheBtn = document.getElementById('clearRussianCacheBtn');
    const russianStatsSpan = document.getElementById('russianStats');
    const russianResultDiv = document.getElementById('russianMovieResult');
    const russianResultContent = document.getElementById('russianMovieResultContent');

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ä—É—Å—Å–∫–∏—Ö —Ñ–∏–ª—å–º–æ–≤
    async function loadRussianStats() {
      try {
        const res = await fetch('/api/russian-movies/stats');
        const data = await res.json();
        
        if (data.success) {
          const stats = data.data;
          const localDB = stats.localDatabase;
          russianStatsSpan.textContent = `–ö—ç—à: ${stats.cacheSize}, –ë–∞–∑–∞: ${localDB.totalMovies} —Ñ–∏–ª—å–º–æ–≤, ${localDB.totalSeries} —Å–µ—Ä–∏–∞–ª–æ–≤`;
        } else {
          russianStatsSpan.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏';
        }
      } catch (error) {
        console.error('Error loading russian stats:', error);
        russianStatsSpan.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
      }
    }

    // –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ —Ä—É—Å—Å–∫–∏—Ö —Ñ–∏–ª—å–º–æ–≤
    if (clearRussianCacheBtn) {
      clearRussianCacheBtn.addEventListener('click', async () => {
        if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à —Ä—É—Å—Å–∫–∏—Ö —Ñ–∏–ª—å–º–æ–≤?')) {
          return;
        }
        
        try {
          const res = await fetch('/api/russian-movies/cache/clear', { method: 'POST' });
          const data = await res.json();
          
          if (data.success) {
            alert('–ö—ç—à —Ä—É—Å—Å–∫–∏—Ö —Ñ–∏–ª—å–º–æ–≤ –æ—á–∏—â–µ–Ω');
            loadRussianStats(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
          } else {
            alert(data.msg || '–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞');
          }
        } catch (error) {
          console.error('Error clearing russian cache:', error);
          alert('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞: ' + error.message);
        }
      });
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ
    if (loadRussianStatsBtn) {
      loadRussianStatsBtn.addEventListener('click', loadRussianStats);
    }

    // –§–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ —Ä—É—Å—Å–∫–∏—Ö —Ñ–∏–ª—å–º–æ–≤
    if (russianSearchForm) {
      console.log('‚úÖ –§–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ —Ä—É—Å—Å–∫–∏—Ö —Ñ–∏–ª—å–º–æ–≤ –Ω–∞–π–¥–µ–Ω–∞');
      
      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
      const queryInput = document.getElementById('russianMovieQuery');
      const yearInput = document.getElementById('russianMovieYear');
      
      if (queryInput) {
        console.log('‚úÖ –ü–æ–ª–µ –≤–≤–æ–¥–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞–π–¥–µ–Ω–æ');
        queryInput.addEventListener('input', (e) => {
          console.log('–í–≤–æ–¥ –≤ –ø–æ–ª–µ –∑–∞–ø—Ä–æ—Å–∞:', e.target.value);
        });
      } else {
        console.error('‚ùå –ü–æ–ª–µ –≤–≤–æ–¥–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
      }
      
      if (yearInput) {
        console.log('‚úÖ –ü–æ–ª–µ –≤–≤–æ–¥–∞ –≥–æ–¥–∞ –Ω–∞–π–¥–µ–Ω–æ');
      } else {
        console.error('‚ùå –ü–æ–ª–µ –≤–≤–æ–¥–∞ –≥–æ–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
      }
      
      russianSearchForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        console.log('üìù –§–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
        
        const query = document.getElementById('russianMovieQuery')?.value?.trim();
        const year = document.getElementById('russianMovieYear')?.value?.trim();
        
        console.log('üîç –ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å:', { query, year });
        
        if (!query) {
          alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞');
          return;
        }
        
        try {
          const requestBody = { query };
          if (year) {
            requestBody.year = parseInt(year);
          }
          
          console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', requestBody);
          
          const res = await fetch('/api/russian-movies/search', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
          });
          
          console.log('üì• –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç, —Å—Ç–∞—Ç—É—Å:', res.status);
          
          const data = await res.json();
          console.log('üì• –î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞:', data);
          
          if (data.success) {
            const movie = data.data;
            russianResultContent.innerHTML = `
              <div class="row">
                <div class="col-md-8">
                  <h5>${movie.title} (${movie.year})</h5>
                  <p><strong>–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:</strong> ${movie.original_title}</p>
                  <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${movie.overview || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                  <p><strong>–†–µ–∂–∏—Å—Å–µ—Ä:</strong> ${movie.director || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                  <p><strong>–ê–∫—Ç–µ—Ä—ã:</strong> ${movie.cast?.join(', ') || '–ù–µ —É–∫–∞–∑–∞–Ω—ã'}</p>
                  <p><strong>–ñ–∞–Ω—Ä—ã:</strong> ${movie.genres?.join(', ') || '–ù–µ —É–∫–∞–∑–∞–Ω—ã'}</p>
                  <p><strong>–†–µ–π—Ç–∏–Ω–≥:</strong> ${movie.rating || '–ù–µ—Ç'}</p>
                  <p><strong>–Ø–∑—ã–∫ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞:</strong> ${movie.original_language}</p>
                  <p><strong>–†—É—Å—Å–∫–∏–π —Ñ–∏–ª—å–º:</strong> ${movie.is_russian ? '–î–∞' : '–ù–µ—Ç'}</p>
                  <p><strong>–ü–µ—Ä–µ–≤–æ–¥:</strong> ${movie.is_translation ? '–î–∞' : '–ù–µ—Ç'}</p>
                  <p><strong>–ò—Å—Ç–æ—á–Ω–∏–∫:</strong> ${movie.source === 'local_database' ? '–õ–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö' : 
                    movie.source === 'kinopoisk' ? 'Kinopoisk API' :
                    movie.source === 'kinopoisk_web' ? 'Kinopoisk (–ø–∞—Ä—Å–∏–Ω–≥)' :
                    movie.source === 'rutor' ? 'Rutor.info' :
                    movie.source === 'nyaa' ? 'Nyaa.si' :
                    movie.source === 'tmdb' ? 'TMDB' : movie.source}</p>
                  <p><strong>–¢–∏–ø:</strong> ${movie.type === 'series' ? '–°–µ—Ä–∏–∞–ª' : '–§–∏–ª—å–º'}</p>
                </div>
                <div class="col-md-4">
                  ${movie.poster_path ? `<img src="https://image.tmdb.org/t/p/w200${movie.poster_path}" class="img-fluid rounded" alt="–ü–æ—Å—Ç–µ—Ä">` : '<p>–ü–æ—Å—Ç–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</p>'}
                </div>
              </div>
            `;
            russianResultDiv.style.display = 'block';
            console.log('‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω');
          } else {
            russianResultContent.innerHTML = `<p class="text-danger">${data.msg}</p>`;
            russianResultDiv.style.display = 'block';
            console.log('‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', data.msg);
          }
        } catch (error) {
          console.error('üí• –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ —Ä—É—Å—Å–∫–∏—Ö —Ñ–∏–ª—å–º–æ–≤:', error);
          russianResultContent.innerHTML = `<p class="text-danger">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ${error.message}</p>`;
          russianResultDiv.style.display = 'block';
        }
      });
    } else {
      console.error('‚ùå –§–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ —Ä—É—Å—Å–∫–∏—Ö —Ñ–∏–ª—å–º–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadRussianStats();
  });
</script>

